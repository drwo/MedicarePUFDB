---
title: "Medicare PUF DB, Part 1"
author: "Tom Woteki, drwo@vt.edu"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

# Introduction

## Project

This notebook is part of a project that constructs a relational database from datasets known as the “Medicare Fee-For-Service Provider Utilization and Payment Data, Physician and Other Supplier Public Use File” downloaded from data.cms.gov. Part 1 of the notebook provides the code to import the raw data and prepare it for uploading into a MySQL database. Part 2 creates and loads the database as a service encapsulated as a Docker container. The resulting database is intended to be used as a source of data for the statistical computing courses offered as part of the Data Science option of the DAAS degree.

## The Data

The datasets provided by CMS cover 2012 through 2017 as of August 2019. As described by the Office of Information Products and Data Analytics of the Centers for Medicare and Medicaid Services (CMS), the datasets include “information on utilization, payment (allowed amount and Medicare payment), and submitted charges by National Provider Identifier (NPI), type of provider, Healthcare Common Procedure Coding System (HCPCS) code, and place of service”. The data cover payments to over 1 million individual and organizational providers identified by their NPI for services corresponding to over 6,000 HCPCS codes.

A small number of records in the datasets pertain to providers in foreign locations. We have chosen to remove those so that the data pertain solely to US providers. See below.

In a “frequently asked question” section of its web site, CMS states that average payment was calculated as total payment for the services divided by quantity of the service delivered. Therefore, one can convert average payments back to totals by multiplying the average payment by the quantity of the service.

# Part 1: Import and Standardize the Raw Data

## Column Names
There are 28 variables for each 2012 and 2013 record. The following defines the variable names for the 28 variables for both years. The names we have chosen parallel the names described in CMS's documentation "Medicare-Physician-and-Other-Supplier-PUF-Methodology" but are shorter and somewhat more convenient to use. See the documentation for definitions of the variables.

```{r}
puf20123.colnames<-c("NPI", "org.name", "first.name", "mi", "credentials", "gender", "entity.code", "street1", "street2", "city", "zip", "state", "country", "prov.type", 
                     "medicare.indicator", "svc.place", "hcpcs.code", "hcpcs.description", "drug.indicator", "svc.count", "bene.count", "bene.day.svc.count", 
                     "avg.allowed.amt", "stdev.allowed.amt", "avg.chrg.amt", "stdev.chrg.amt", "avg.payment", "stdev.payment")
```

From 2014 onward CMS dropped the three standard deviations of payments (see column names above) and added a new payment variable: average medicare standard payment resulting in 25 variables. The following defines the variable names we have chosen for the 25 variables 2014 through 2017 data.

```{r}
puf2014567.colnames<-c("NPI", "org.name", "first.name", "mi", "credentials", "gender", "entity.code", "street1", "street2", "city", "zip", "state", "country", "prov.type", 
                       "medicare.indicator", "svc.place", "hcpcs.code", "hcpcs.description", "drug.indicator", "svc.count", "bene.count", "bene.day.svc.count", 
                       "avg.allowed.amt", "avg.chrg.amt", "avg.payment", "avg.standard.amt")
```

## Column Classes
The following defines the data classes for the variables in each record. Three of the variables being counts (svc.count, bene.count, bene.day.svc.count) suggest that these values should be integers. However, in an earlier version of this project we found that at least one of these variables has floating point values. Hence we have classified all of the counts as numeric rather than integer. The remaining variables are classed as character, even though some could have been classed as factor.

```{r}
puf20123.colclasses<-c("character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric")
puf2014567.colclasses<-c("character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "character", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric")
```


## Utility Import Function
The following utility function imports data for a given year into a tibble. We skip 2 lines in the file (parameters skip=2, and header=FALSE). The first of these lines corresponds to the variable names in the CMS documentation and the second line is a copyright statement. Rather than edit the original files to remove the copyright statement we skip these 2 lines and provide our own, shorter, variable names as above. The files are tab delimited, hence parameter sep="\t". There are numerous instances of the character "'" as in CHILDREN'S HOSPITAL that can cause a problem. Hence we set parameter quote="" to avoid this. The remaining parameter settings should be self-explanatory

```{r}
read.puf <- function(path.to.data, col.names, col.classes) {
  as_tibble(read.table(path.to.data, 
                       sep="\t", na.strings=c("NA",""), header=FALSE, 
                       comment.char="", quote="", col.names=col.names, colClasses=col.classes, skip=2))
}
```

## Import Raw Data
Here we import the raw data for each year. Recall that 2012 and 2013 each have 28 variables whereas 2014 through 2017 have only 26.

```{r}
path.prefix <- "/Users/drwo/Documents/Workshop/RProjects/MedicarePUFDB/rawData/Medicare_Provider_Util_Payment_PUF_"
puf2012 <- read.puf(paste0(path.prefix, "CY2012.txt"), puf20123.colnames, puf20123.colclasses)
puf2013 <- read.puf(paste0(path.prefix, "CY2013.txt"), puf20123.colnames, puf20123.colclasses)
puf2014 <- read.puf(paste0(path.prefix, "CY2014.txt"), puf2014567.colnames, puf2014567.colclasses)
puf2015 <- read.puf(paste0(path.prefix, "CY2015.txt"), puf2014567.colnames, puf2014567.colclasses)
puf2016 <- read.puf(paste0(path.prefix, "CY2016.txt"), puf2014567.colnames, puf2014567.colclasses)
puf2017 <- read.puf(paste0(path.prefix, "CY2017.txt"), puf2014567.colnames, puf2014567.colclasses)
```

## Standardize Data
The 2012 and 2013 data include three variables that are not in the 2014 and later data: std.dev.allowed.amt, stdev.chrg.amt and stdev.payment. We remove those columns to match the later years and standardize the data even though the standard deviations could otherwise be of interest to explore.

```{r}
puf2012 <- puf2012 %>%
  select(-stdev.allowed.amt, -stdev.chrg.amt, -stdev.payment)
puf2013 <- puf2013 %>%
  select(-stdev.allowed.amt, -stdev.chrg.amt, -stdev.payment)
```

The later years datasets include the variable avg.standard.amt not found in 2012 or 2013. For sake of standardization delete it.
```{r}
puf2014 <- puf2014 %>%
  select(-avg.standard.amt)
puf2015 <- puf2015 %>%
  select(-avg.standard.amt)
puf2016 <- puf2016 %>%
  select(-avg.standard.amt)
puf2017 <- puf2017 %>%
  select(-avg.standard.amt)
```

Add a year variable as a factor to each of the puf datasets:

```{r}
add.yr <- function(puf.yr, yr) {
  puf.yr %>%
    add_column(year = factor(yr, levels = c("2012", "2013", "2014", "2015", "2016", "2017")), .before = "NPI")
}
puf2012 <- add.yr(puf2012, "2012")
puf2013 <- add.yr(puf2013, "2013")
puf2014 <- add.yr(puf2014, "2014")
puf2015 <- add.yr(puf2015, "2015")
puf2016 <- add.yr(puf2016, "2016")
puf2017 <- add.yr(puf2017, "2017")
```

In some cases zip is a 5 character string of the form "20003". In other cases it is a 9 or 10 character string of the form "200031234" or "20003-1234". We standardize to 5 character strings:
```{r}
puf2012$zip <- substr(puf2012$zip, 1, 5)
puf2013$zip <- substr(puf2013$zip, 1, 5)
puf2014$zip <- substr(puf2014$zip, 1, 5)
puf2015$zip <- substr(puf2015$zip, 1, 5)
puf2016$zip <- substr(puf2016$zip, 1, 5)
puf2017$zip <- substr(puf2017$zip, 1, 5)
```

Now that all the yearly data frames are standardized, create one master and remove the yearly frames. Do this a step at a time to conserve memory.

```{r}
puf <- rbind(puf2012, puf2013)
rm(puf2012, puf2013)
puf <- puf %>% rbind(puf2014)
rm(puf2014)
puf <- puf %>% rbind(puf2015)
rm(puf2015)
puf <- puf %>% rbind(puf2016)
rm(puf2016)
puf <- puf %>% rbind(puf2017)
rm(puf2017)
gc()
```

We are only going to consider claims that originate in the US or providers in the US. There are `r puf %>% filter(country != "US") %>% nrow()` non-US claims. Remove these claim records.
```{r}
puf <- puf %>%
  filter(country == "US")
```

The following chunk assigns a unique numerical ID, a row number, to each claim record. We may use this later to relate tables that we will create from the data.
```{r}
puf <- puf %>%
  arrange(year, NPI) %>%
  add_column(ID = 1:nrow(puf), .before = "year")
```

```{r}
n.claims <- nrow(puf)
```

We now have a initial standardized dataset consisting of `r format(n.claims, big.mark = ",")` claims.


